<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>tourMap</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.1.15/leaflet-providers.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <style>
      body {
        padding: 0;
        margin: 0;
      }
      html, body{
        height: 100%;
      }
      #map, #weather{
        height: 50%;
      }

      .enter{
        color: green;
      }
      .update{
        color: #333;
      }

    </style>
  </head>
  <body>

    <div id="map"></div>
    <div id="weather">
      
    <svg width="500" height="300"></svg>

    </div>

    <script>

      var map = L.map('map');
      L.tileLayer.provider('OpenStreetMap.BlackAndWhite').addTo(map);
      map.setView([59.311162, 18.074806], 13);

      map.on('click', onMapClick);

      function onMapClick(e){
        update(e.latlng.lat, e.latlng.lng);
      }

      function update(lat, lng){
        var data = [];

        var localproxy = "proxy?url="
        // var localproxy = "http://localhost:3000/?url="

        var urlOpenweather = "http://api.openweathermap.org/data/2.5/forecast/daily?lat="+ lat + "&lon="+ lng + "&cnt=10&appid=c49e630f0dba743273c6876aea593115";

        var urlDarksky = "https://api.darksky.net/forecast/b0b3a61c7b298b74be766a5d9a40bf70/" + lat + "," + lng + "?"
        + "lang=sv"
        + "&units=si";

        console.log(urlDarksky);

        d3.json(localproxy + urlDarksky,
          function(error, json) {
            if(error) return console.warn(error);

            data.push(json);
            draw(data);

          });
      }

      var weather = d3.select("#weather");

      var svg = d3.select("svg"),
       margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var parseTime = d3.timeParse("%d-%y");

      var xScale = d3.scaleTime()
        .rangeRound([0, width]);

      var yScale = d3.scaleLinear()
        .rangeRound([height, 0]);

      var line = d3.line()
        .x(function(d){ 
          console.log(d.time);
          return xScale(d.time);
        })
        .y(function(d){
          return yScale(d.temperature);
        });

      g.append("g")
        .attr("class", "axisBottom");

      g.append("g")
        .attr("class", "axisLeft")
        .append("text");

      g.append("path")
        .attr("class", "line")
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1.5);


      function draw(dataset){

        var key = function(d){
          // return d.currently.summary;
          return d.time;
        }

        var mydata = dataset[0].hourly.data;
        mydata.forEach(function(d){
          d.time = new Date(d.time * 1000);
          d.temperature = +d.temperature;
        })

        xScale.domain(d3.extent(mydata, function(d) { return d.time; }));
        // yScale.domain([-40, 40]);
        yScale.domain(d3.extent(mydata, function(d) { return d.temperature; }));

        
        g.select(".line")
          .transition()
          .duration(500)
          .attr("d", line(mydata));

        g.select(".axisBottom")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(xScale));

        g.select(".axisLeft")
          .call(d3.axisLeft(yScale))
          .select("text")
          .attr("fill", "#000")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", "0.71em")
          .attr("text-anchor", "end")
          .text("temp");

        //mouseover
        svg.selectAll("circle")
          .data(mydata)
          .enter().append("circle")
          .attr("r", 5)
          .attr("cx", function(d){
            return xScale(d.time);
          })
          .attr("cy", function(d){
            return yScale(d.temperature);
          })
          .style("fill","none")
          .style("stroke","none")
          .style("pointer-events","all")
          .append("title")
          .text(function(d) { return "Temp: " + d.temperature + "Â°"; });

        console.log(mydata);

        // var info = weather.selectAll("p")
        //   .data(dataset, key);

        // info
        //   .attr("class", "update");

        // info
        //   .enter()
        //   .append("p")
        //   .attr("class", "enter")
        //   .text(function(d){
        //     return d.currently.summary;
        //     // return d.city.name;
        //   });

        // info.exit().remove();

      }

    </script>

  </body>
</html>
